name: Docker

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  ALIYUN_REGISTRY: "${{ secrets.ALIYUN_REGISTRY }}"
  ALIYUN_NAME_SPACE: "${{ secrets.ALIYUN_NAME_SPACE }}"
  ALIYUN_REGISTRY_USER: "${{ secrets.ALIYUN_REGISTRY_USER }}"
  ALIYUN_REGISTRY_PASSWORD: "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"

jobs:
  build:
    name: Pull images
    runs-on: ubuntu-latest
    strategy:
      matrix:
        chunk: [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19] # 并行 20 个 job
      max-parallel: 19
    steps:
      - name: Before freeing up disk space
        run: |
          echo "Before freeing up disk space"
          echo "=============================================================================="
          df -hT
          echo "=============================================================================="

      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 2048
          swap-size-mb: 128
          remove-dotnet: 'true'
          remove-haskell: 'true'
          build-mount-path: '/var/lib/docker/'

      - name: Restart docker
        run: sudo service docker restart

      - name: Free up disk space complete
        run: |
          echo "Free up disk space complete"
          echo "=============================================================================="
          df -hT
          echo "=============================================================================="

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Docker Setup Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Aliyun Registry
        run: |
          docker login -u $ALIYUN_REGISTRY_USER -p $ALIYUN_REGISTRY_PASSWORD $ALIYUN_REGISTRY

      - name: Build and push image Aliyun (skip existing)
        run: |
          # 分片处理 images.txt
          total_chunks=20
          chunk_index=${{ matrix.chunk }}
          total_lines=$(wc -l < images.txt)
          images_per_chunk=$(( (total_lines + total_chunks - 1)/total_chunks ))
          start=$((chunk_index * images_per_chunk + 1))
          end=$((start + images_per_chunk - 1))
          if [ $end -gt $total_lines ]; then end=$total_lines; fi

          sed -n "${start},${end}p" images.txt | while IFS= read -r line || [ -n "$line" ]; do
              [[ -z "$line" || "$line" =~ ^\s*# ]] && continue

              echo "Processing $line ..."

              # 生成目标阿里云镜像名
              platform=$(echo "$line" | awk -F'--platform[ =]' '{if (NF>1) print $2}' | awk '{print $1}')
              platform_prefix=${platform:+${platform//\//_}_}

              image_name_tag=$(echo "$line" | awk -F'/' '{print $NF}')
              name_space=$(echo "$line" | awk -F'/' '{if (NF==3) print $2; else if (NF==2) print $1; else print ""}')
              image_name=$(echo "$image_name_tag" | awk -F':' '{print $1}')

              # 避免同名镜像冲突
              new_image="$ALYUN_REGISTRY/$ALYUN_NAME_SPACE/$platform_prefix${name_space}_$image_name_tag"

              # ✅ 先检查阿里云镜像是否存在
              if docker manifest inspect "$new_image" > /dev/null 2>&1; then
                  echo "Image $new_image already exists on Aliyun. Skipping pull and push."
                  continue
              fi

              # 拉取源镜像
              if ! docker pull "$line"; then
                  echo "Warning: Failed to pull $line. Skipping."
                  continue
              fi

              # tag 并 push
              docker tag "$line" "$new_image"
              docker push "$new_image"

              # 清理本地镜像
              docker rmi "$line" "$new_image" || true
          done
